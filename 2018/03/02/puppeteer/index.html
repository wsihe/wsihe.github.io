<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge, chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="keywords" content="river,前端,设计,前端开发,用户体验,设计,frontend,design,nodejs,JavaScript"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><title>Puppeteer-爬取页面并打印成PDF</title><body><div class="container"><div class="nav"><ul><li class="item"><a href="/">主页</a></li><li class="item"><a href="/archives">归档</a></li><li class="item"><a href="/about/">关于</a></li></ul></div><article><header><h1 class="title">Puppeteer-爬取页面并打印成PDF</h1><i class="icon-calendar"></i><span>2018.03.02</span></header><div class="content"><p>在之前的项目中做过将HTML页面转成PDF的功能，当时使用的技术是 PhantomJS + Python，鉴于 PhantomJS 已经都超过2年没有发布新版本了，而 Puppeteer 目前在 Github 上已经接近 3w star，计划用 Puppeteer 代替之前的方案，故先在个人项目上做了一次技术验证。</p>
<a id="more"></a>
<h2 id="Puppeteer"><a href="#Puppeteer" class="headerlink" title="Puppeteer"></a>Puppeteer</h2><p><a href="https://github.com/GoogleChrome/puppeteer" target="_blank" rel="noopener">Puppeteer</a> 是一个通过 DevTools Protocol 控制 headless chrome 的 high-level Node 库，也可以通过设置使用 非 headless Chrome。</p>
<p>在浏览器中手动完成的大部分事情都可以使用Puppeteer完成，包括：</p>
<ul>
<li>生成页面的截图和PDF。</li>
<li>抓取SPA并生成预先呈现的内容（即“SSR”）。</li>
<li>从网站抓取你需要的内容。</li>
<li>自动表单提交，UI测试，键盘输入等</li>
<li>创建一个最新的自动化测试环境。使用最新的JavaScript和浏览器功能，直接在最新版本的Chrome中运行测试。</li>
<li>捕获您的网站的时间线跟踪，以帮助诊断性能问题。</li>
</ul>
<p>例如官方的示例 - 导航到 example.com 并将截屏保存为example.png：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const puppeteer = require(&apos;puppeteer&apos;);</span><br><span class="line"></span><br><span class="line">(async () =&gt; &#123;</span><br><span class="line">  const browser = await puppeteer.launch();</span><br><span class="line">  const page = await browser.newPage();</span><br><span class="line">  await page.goto(&apos;https://example.com&apos;);</span><br><span class="line">  await page.screenshot(&#123;path: &apos;example.png&apos;&#125;);</span><br><span class="line"></span><br><span class="line">  await browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>简单的几行代码就实现了页面截图的功能；</p>
<h2 id="创建PDF"><a href="#创建PDF" class="headerlink" title="创建PDF"></a>创建PDF</h2><p>首先安装 Puppeteer ，要注意的是 Puppeteer 至少需要Node v6.4.0，用到async / await的话，它需要Node v7.6.0或更高版本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i puppeteer</span><br></pre></td></tr></table></figure>
<p>另外，还会下载一个下载最新版本的 Chromium（〜71Mb Mac，〜90Mb Linux，〜110Mb Win），保证与 API 协同工作。</p>
<p>官方提供简单的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const puppeteer = require(&apos;puppeteer&apos;);</span><br><span class="line"></span><br><span class="line">(async () =&gt; &#123;</span><br><span class="line">  const browser = await puppeteer.launch();</span><br><span class="line">  const page = await browser.newPage();</span><br><span class="line">  await page.goto(&apos;https://wusihe.com&apos;, &#123;waitUntil: &apos;networkidle2&apos;&#125;);</span><br><span class="line">  await page.pdf(&#123;path: &apos;hn.pdf&apos;, format: &apos;A4&apos;&#125;);</span><br><span class="line"></span><br><span class="line">  await browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<ul>
<li>使用puppeteer.launch()运行puppeteer，获取browser实例</li>
<li>拿到browser实例后，通过browser.newPage()方法，可以得到一个page实例</li>
<li>使用page.goto()方法</li>
<li>爬取页面，使用page.pdf()方法打印页面</li>
</ul>
<p>要注意的是，要等页面渲染完成后才打印页面，改进后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const puppeteer = require(&apos;puppeteer&apos;);</span><br><span class="line"></span><br><span class="line">puppeteer.launch(&#123; headless: true &#125;).then(async browser =&gt; &#123;</span><br><span class="line">  let page = await browser.newPage()</span><br><span class="line">  page.setViewport(&#123; width: 1024, height: 2048 &#125;)</span><br><span class="line"></span><br><span class="line">  page</span><br><span class="line">    .waitForSelector(&apos;img&apos;)</span><br><span class="line">    .then(async() =&gt; &#123;</span><br><span class="line">      await page.goto(&apos;https://wusihe.com&apos;, &#123;waitUntil: &apos;networkidle2&apos;&#125;);</span><br><span class="line">      await page.pdf(&#123;path: &apos;hn.pdf&apos;, format: &apos;A4&apos;&#125;);</span><br><span class="line">      page.close()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">	browser.close();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="需要登陆的情况"><a href="#需要登陆的情况" class="headerlink" title="需要登陆的情况"></a>需要登陆的情况</h4><ul>
<li>打开目标地址登录页面；</li>
<li>填充用户名和密码并“点击”登录按钮，完成登录跳转到具体页面；</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">async(page) =&gt; &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    await page.goto(&apos;http://localhost:4000/#/login&apos;)</span><br><span class="line"></span><br><span class="line">    await page.type(&apos;#id&apos;, &apos;3009333&apos;, &#123; delay: 20 &#125;)</span><br><span class="line">    await page.type(&apos;#id&apos;, &apos;123456&apos;, &#123; delay: 20 &#125;)</span><br><span class="line"></span><br><span class="line">    let loginBtn = await page.$(&apos;[name=commit]&apos;)</span><br><span class="line">    await loginBtn.click(&#123;delay: 20&#125;)</span><br><span class="line"></span><br><span class="line">    await page.waitFor(600)</span><br><span class="line">    return Promise.resolve(1)</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    return Promise.resolve(0)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有关创建PDF的更多信息，可以参考<a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md#pagepdfoptions" target="_blank" rel="noopener">Page.pdf（）</a>。</p>
</div></article></div></body></head></html>